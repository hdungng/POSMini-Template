<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>POS Template</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app">
        <header>
            <div class="brand">üßæ POS Mini</div>
            <div class="search">
                <input id="search" placeholder="T√¨m s·∫£n ph·∫©m ‚Äî / ƒë·ªÉ focuss" />
                <button class="btn" id="clearCart" title="Alt+X">Xo√° gi·ªè</button>
            </div>
            <div style="text-align:right;display:flex;gap:8px;justify-content:flex-end;align-items:center">
                <button class="btn" id="manageBtn" title="Qu·∫£n l√Ω s·∫£n ph·∫©m (Alt+M)">Qu·∫£n l√Ω SP</button>
                <div class="note">Ph√≠m t·∫Øt: <b>/</b> T√¨m ‚Ä¢ <b>Alt+P</b> Thanh to√°n ‚Ä¢ <b>Alt+M</b> Qu·∫£n l√Ω ‚Ä¢ <b>Alt+X</b>
                    Xo√° gi·ªè</div>
            </div>
        </header>

        <main>
            <!-- Danh m·ª•c -->
            <section class="panel">
                <h3>Danh m·ª•c</h3>
                <div class="categories" id="categories"></div>
            </section>

            <!-- L∆∞·ªõi s·∫£n ph·∫©m -->
            <section class="panel catalog">
                <h3>S·∫£n ph·∫©m</h3>
                <div class="grid" id="productGrid"></div>
            </section>

            <!-- Gi·ªè h√†ng -->
            <section class="panel cart">
                <h3>Gi·ªè h√†ng</h3>
                <div class="cart-body" id="cartList"></div>
                <div class="cart-footer">
                    <div class="inputs">
                        <label>Gi·∫£m gi√° (ƒë)
                            <input type="number" id="discount" min="0" step="1000" value="0">
                        </label>
                        <label>Thu·∫ø VAT
                            <select id="taxRate">
                                <option value="0">0%</option>
                                <option value="0.05">5%</option>
                                <option value="0.1" selected>10%</option>
                            </select>
                        </label>
                    </div>
                    <div class="rows">
                        <div class="row"><span>T·∫°m t√≠nh</span><span id="subtotal">0</span></div>
                        <div class="row"><span>Thu·∫ø</span><span id="tax">0</span></div>
                        <div class="row"><span>Gi·∫£m gi√°</span><span id="discountShow">0</span></div>
                        <div class="row"><strong>T·ªïng c·ªông</strong><strong id="grandTotal">0</strong></div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class="btn ghost" id="hold">Gi·ªØ ho√° ƒë∆°n</button>
                        <button class="btn primary" id="payBtn" title="Alt+P">Thanh to√°n</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal thanh to√°n -->
    <div class="backdrop" id="payModal">
        <div class="modal">
            <h2>Thanh to√°n</h2>
            <div class="grid2">
                <div>
                    <label>Ph∆∞∆°ng th·ª©c</label>
                    <select id="payMethod">
                        <option>Ti·ªÅn m·∫∑t</option>
                        <option>Th·∫ª</option>
                        <option>Chuy·ªÉn kho·∫£n</option>
                        <option>V√≠ ƒëi·ªán t·ª≠</option>
                    </select>
                </div>
                <div>
                    <label>Ti·ªÅn kh√°ch ƒë∆∞a (ƒë)</label>
                    <input type="number" id="cashGiven" min="0" step="1000" />
                </div>
            </div>
            <div class="row"><span>T·ªïng ph·∫£i thu</span><strong id="due">0</strong></div>
            <div class="row"><span>Ti·ªÅn th·ªëi</span><strong id="change">0</strong></div>
            <div class="note">M·∫πo: g√µ s·ªë r·ªìi Enter ƒë·ªÉ ho√†n t·∫•t.</div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="btn" id="closePay">Hu·ª∑</button>
                <button class="btn primary" id="completeSale">Ho√†n t·∫•t & In</button>
            </div>
        </div>
    </div>

    <!-- Modal qu·∫£n l√Ω s·∫£n ph·∫©m -->
    <div class="backdrop" id="manageModal">
        <div class="modal" style="max-width:900px">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h2>Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
                <div>
                    <button class="btn" id="newProduct">+ Th√™m s·∫£n ph·∫©m</button>
                    <button class="btn" id="closeManage">ƒê√≥ng</button>
                </div>
            </div>
            <div style="overflow:auto;max-height:60vh">
                <table class="table" id="productTable">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>T√™n</th>
                            <th>Danh m·ª•c</th>
                            <th>Gi√°</th>
                            <th>·∫¢nh</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal form s·∫£n ph·∫©m -->
    <div class="backdrop" id="formModal">
        <div class="modal">
            <h3 id="formTitle">Th√™m s·∫£n ph·∫©m</h3>
            <div class="grid3">
                <div>
                    <label>M√£ (ID)</label>
                    <input id="f_id" placeholder="VD: CF001">
                </div>
                <div>
                    <label>T√™n</label>
                    <input id="f_name" placeholder="T√™n s·∫£n ph·∫©m">
                </div>
                <div>
                    <label>Danh m·ª•c</label>
                    <input id="f_cat" list="catList" placeholder="VD: ƒê·ªì u·ªëng">
                    <datalist id="catList"></datalist>
                </div>
            </div>
            <div class="grid2">
                <div>
                    <label>Gi√° (ƒë)</label>
                    <input type="number" id="f_price" min="0" step="1000">
                </div>
                <div>
                    <label>·∫¢nh (URL)</label>
                    <input type="url" id="f_image" placeholder="https://...">
                </div>
            </div>
            <div>
                <div class="note">Ho·∫∑c t·∫£i ·∫£nh t·ª´ m√°y (PNG/JPG):</div>
                <input type="file" id="f_file" accept="image/*">
                <div style="margin-top:8px;display:flex;gap:12px;align-items:center">
                    <div class="thumb" style="width:140px"><img id="f_preview" alt=""></div>
                    <div class="note">·∫¢nh s·∫Ω ƒë∆∞·ª£c l∆∞u d·∫°ng base64 trong LocalStorage (ch·ªâ d√πng n·ªôi b·ªô tr√™n m√°y n√†y).
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="btn" id="formCancel">Hu·ª∑</button>
                <button class="btn primary" id="formSave">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- Khu v·ª±c in -->
    <div id="receipt"></div>

    <script>
        (function () {
            // ====== L∆ØU TR·ªÆ ======
            const LS_KEY = "pos_products";
            const byId = id => document.getElementById(id);
            const fmt = n => n.toLocaleString("vi-VN");

            // M·∫´u v·ªõi ·∫£nh th·ª±c t·∫ø (Unsplash)
            const defaultProducts = [
                { id: "CF001", name: "C√† ph√™ s·ªØa", price: 25000, cat: "ƒê·ªì u·ªëng", image: "https://images.unsplash.com/photo-1512568400610-62da28bc8a13?q=80&w=800&auto=format&fit=crop" },
                { id: "CF002", name: "C√† ph√™ ƒëen", price: 22000, cat: "ƒê·ªì u·ªëng", image: "https://images.unsplash.com/photo-1503481766315-7a586b20f66d?q=80&w=800&auto=format&fit=crop" },
                { id: "TE001", name: "Tr√† ƒë√†o", price: 30000, cat: "ƒê·ªì u·ªëng", image: "https://images.unsplash.com/photo-1544145945-f90425340c7e?q=80&w=800&auto=format&fit=crop" },
                { id: "TE002", name: "Tr√† chanh", price: 18000, cat: "ƒê·ªì u·ªëng", image: "https://images.unsplash.com/photo-1497534547324-0ebb3f052e88?q=80&w=800&auto=format&fit=crop" },
                { id: "FD001", name: "B√°nh m√¨ th·ªãt", price: 35000, cat: "ƒê·ªì ƒÉn", image: "https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=800&auto=format&fit=crop" },
                { id: "FD002", name: "M√¨ x√†o b√≤", price: 55000, cat: "ƒê·ªì ƒÉn", image: "https://images.unsplash.com/photo-1589301773859-b000f3f9ce5a?q=80&w=800&auto=format&fit=crop" },
                { id: "SN001", name: "Khoai t√¢y chi√™n", price: 28000, cat: "Snack", image: "https://images.unsplash.com/photo-1541592106381-b31e9677c0e5?q=80&w=800&auto=format&fit=crop" },
                { id: "SN002", name: "B·∫Øp rang b∆°", price: 20000, cat: "Snack", image: "https://images.unsplash.com/photo-1513104890138-7c749659a591?q=80&w=800&auto=format&fit=crop" },
                { id: "OT001", name: "T√∫i nilon", price: 2000, cat: "Kh√°c", image: "https://images.unsplash.com/photo-1520975922323-0f2262cbb7f1?q=80&w=800&auto=format&fit=crop" },
                { id: "OT002", name: "KhƒÉn gi·∫•y", price: 5000, cat: "Kh√°c", image: "https://images.unsplash.com/photo-1581761896161-878c6de86b7e?q=80&w=800&auto=format&fit=crop" },
            ];
            function loadProducts() {
                try {
                    const raw = localStorage.getItem(LS_KEY);
                    if (!raw) return defaultProducts.slice();
                    const arr = JSON.parse(raw);
                    if (!Array.isArray(arr) || arr.length === 0) return defaultProducts.slice();
                    return arr;
                } catch (e) { console.warn(e); return defaultProducts.slice(); }
            }
            function saveProducts() { localStorage.setItem(LS_KEY, JSON.stringify(products)); refreshAll(); }
            let products = loadProducts();

            // ====== TR·∫†NG TH√ÅI & UI CHUNG ======
            let activeCat = "T·∫•t c·∫£";
            let query = "";
            const cart = new Map();

            const catWrap = byId("categories");
            const grid = byId("productGrid");
            const search = byId("search");

            // ====== DANH M·ª§C ======
            function getCategories() {
                const set = new Set(products.map(p => p.cat));
                return ["T·∫•t c·∫£", ...Array.from(set).sort((a, b) => a.localeCompare(b))];
            }
            function renderCats() {
                const categories = getCategories();
                if (!categories.includes(activeCat)) activeCat = "T·∫•t c·∫£";
                catWrap.innerHTML = "";
                categories.forEach(c => {
                    const btn = document.createElement("button");
                    btn.className = "cat" + (c === activeCat ? " active" : "");
                    btn.textContent = c;
                    btn.onclick = () => { activeCat = c; renderProducts(); };
                    catWrap.appendChild(btn);
                });
                // c·∫≠p nh·∫≠t datalist cho form
                const dl = byId("catList"); dl.innerHTML = "";
                categories.filter(x => x !== "T·∫•t c·∫£").forEach(c => {
                    const o = document.createElement("option"); o.value = c; dl.appendChild(o);
                });
            }

            // ====== S·∫¢N PH·∫®M (L∆Ø·ªöI) ======
            function renderProducts() {
                const q = query.toLowerCase();
                const list = products.filter(p => {
                    const okCat = activeCat === "T·∫•t c·∫£" || p.cat === activeCat;
                    const okQ = !q || p.name.toLowerCase().includes(q) || p.id.toLowerCase().includes(q);
                    return okCat && okQ;
                });
                grid.innerHTML = "";
                list.forEach(p => {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.innerHTML = `
        <div class="thumb"><img alt="${p.name}" src="${p.image || ""}" onerror="this.src=''; this.parentElement.style.background='linear-gradient(135deg,#eef2ff,#fef3c7)'; this.parentElement.textContent='No Image'"></div>
        <div class="pname">${p.name}</div>
        <div class="muted">M√£: ${p.id} ‚Ä¢ ${p.cat}</div>
        <div class="price">${fmt(p.price)} ƒë</div>
        <button class="btn" data-id="${p.id}">Th√™m</button>
        <div class="edit-badge" title="S·ª≠a s·∫£n ph·∫©m">‚úé</div>
      `;
                    card.querySelector("button").onclick = () => addToCart(p.id);
                    card.querySelector(".edit-badge").onclick = () => openForm(p); // s·ª≠a nhanh
                    grid.appendChild(card);
                });
            }

            // ====== GI·ªé H√ÄNG ======
            const cartList = byId("cartList");
            const subtotalEl = byId("subtotal");
            const taxEl = byId("tax");
            const grandEl = byId("grandTotal");
            const discountInput = byId("discount");
            const discountShow = byId("discountShow");
            const taxRateSel = byId("taxRate");

            function addToCart(id) {
                const p = products.find(x => x.id === id);
                if (!p) return alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m: " + id);
                if (!cart.has(id)) cart.set(id, { ...p, qty: 1 });
                else cart.get(id).qty++;
                renderCart();
            }
            function changeQty(id, delta) {
                if (!cart.has(id)) return;
                const item = cart.get(id);
                item.qty = Math.max(1, item.qty + delta);
                renderCart();
            }
            function removeItem(id) { cart.delete(id); renderCart(); }
            function clearCart() { cart.clear(); renderCart(); }

            function calc() {
                let subtotal = 0;
                cart.forEach(i => { subtotal += i.price * i.qty; });
                const discount = Math.min(Number(discountInput.value || 0), subtotal);
                const tax = Math.max(0, (subtotal - discount) * Number(taxRateSel.value || 0));
                const grand = Math.max(0, subtotal - discount + tax);
                return { subtotal, discount, tax, grand };
            }
            function renderCart() {
                cartList.innerHTML = "";
                cart.forEach(i => {
                    const row = document.createElement("div");
                    row.className = "cart-item";
                    row.innerHTML = `
        <div>
          <div style="font-weight:700">${i.name}</div>
          <div class="muted">${i.id}</div>
        </div>
        <div class="qty">
          <button aria-label="Gi·∫£m">‚àí</button>
          <div>${i.qty}</div>
          <button aria-label="TƒÉng">+</button>
        </div>
        <div class="line-total">${fmt(i.price * i.qty)} ƒë</div>
        <button class="btn danger" aria-label="Xo√°">Xo√°</button>
      `;
                    const [minus, plus] = row.querySelectorAll(".qty button");
                    minus.onclick = () => changeQty(i.id, -1);
                    plus.onclick = () => changeQty(i.id, +1);
                    row.querySelector(".btn.danger").onclick = () => removeItem(i.id);
                    cartList.appendChild(row);
                });
                const { subtotal, discount, tax, grand } = calc();
                subtotalEl.textContent = fmt(subtotal) + " ƒë";
                taxEl.textContent = fmt(tax) + " ƒë";
                discountShow.textContent = "‚àí " + fmt(discount) + " ƒë";
                grandEl.textContent = fmt(grand) + " ƒë";
                byId("due").textContent = fmt(grand) + " ƒë";
            }

            // ====== T√åM KI·∫æM ======
            search.addEventListener("input", e => { query = e.target.value.trim(); renderProducts(); });

            // ====== THANH TO√ÅN ======
            const payModal = byId("payModal");
            const payBtn = byId("payBtn");
            const closePay = byId("closePay");
            const cashGiven = byId("cashGiven");
            const changeEl = byId("change");
            const completeSale = byId("completeSale");

            function openPay() {
                if (cart.size === 0) { alert("Gi·ªè h√†ng ƒëang tr·ªëng."); return; }
                const { grand } = calc();
                byId("due").textContent = fmt(grand) + " ƒë";
                changeEl.textContent = "0 ƒë";
                cashGiven.value = "";
                payModal.style.display = "flex";
                cashGiven.focus();
            }
            function closePayModal() { payModal.style.display = "none"; }

            cashGiven.addEventListener("input", () => {
                const given = Number(cashGiven.value || 0);
                const due = calc().grand;
                const change = Math.max(0, given - due);
                changeEl.textContent = fmt(change) + " ƒë";
            });
            cashGiven.addEventListener("keydown", e => { if (e.key === "Enter") finalize(); });
            completeSale.onclick = finalize;

            // In ho√° ƒë∆°n
            function finalize() {
                const data = Array.from(cart.values());
                const { subtotal, discount, tax, grand } = calc();
                const r = document.getElementById("receipt");
                const now = new Date();
                r.innerHTML = `
      <h2>H√ìA ƒê∆†N B√ÅN L·∫∫</h2>
      <div class="r"><span>POS Mini</span><span>${now.toLocaleString("vi-VN")}</span></div>
      <div>M√£ Hƒê: ${String(now.getTime()).slice(-8)}</div>
      <hr/>
      <ul>
        ${data.map(i => `<li><span>${i.name} x${i.qty}</span><span>${fmt(i.price * i.qty)} ƒë</span></li>`).join("")}
      </ul>
      <hr/>
      <div class="r"><span>T·∫°m t√≠nh</span><span>${fmt(subtotal)} ƒë</span></div>
      <div class="r"><span>Gi·∫£m gi√°</span><span>‚àí ${fmt(discount)} ƒë</span></div>
      <div class="r"><span>Thu·∫ø</span><span>${fmt(tax)} ƒë</span></div>
      <div class="r"><strong>T·ªîNG C·ªòNG</strong><strong>${fmt(grand)} ƒë</strong></div>
      <hr/><div>C·∫£m ∆°n qu√Ω kh√°ch!</div>`;
                closePayModal(); window.print(); clearCart();
            }

            // ====== QU·∫¢N L√ù S·∫¢N PH·∫®M ======
            const manageBtn = byId("manageBtn");
            const manageModal = byId("manageModal");
            const productTableBody = manageModal.querySelector("tbody");
            const closeManage = byId("closeManage");
            const newProductBtn = byId("newProduct");

            function openManage() {
                renderTable(); manageModal.style.display = "flex";
            }
            function closeManageModal() { manageModal.style.display = "none"; }

            function renderTable() {
                productTableBody.innerHTML = "";
                products.forEach(p => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.name}</td>
        <td>${p.cat}</td>
        <td>${fmt(p.price)} ƒë</td>
        <td>${p.image ? '<a href="' + p.image + '" target="_blank">Xem</a>' : '-'}</td>
        <td style="white-space:nowrap">
          <button class="btn" data-act="edit">S·ª≠a</button>
          <button class="btn danger" data-act="del">Xo√°</button>
        </td>
      `;
                    tr.querySelector('[data-act="edit"]').onclick = () => openForm(p);
                    tr.querySelector('[data-act="del"]').onclick = () => deleteProduct(p.id);
                    productTableBody.appendChild(tr);
                });
            }

            function deleteProduct(id) {
                const inCart = cart.has(id);
                if (!confirm("Xo√° s·∫£n ph·∫©m " + id + "?" + (inCart ? "\n(M·ª•c n√†y s·∫Ω b·ªã xo√° kh·ªèi gi·ªè n·∫øu c√≥)" : ""))) return;
                products = products.filter(p => p.id !== id);
                if (inCart) cart.delete(id);
                saveProducts();
            }

            // ====== FORM TH√äM / S·ª¨A ======
            const formModal = byId("formModal");
            const formTitle = byId("formTitle");
            const f_id = byId("f_id"), f_name = byId("f_name"), f_cat = byId("f_cat"), f_price = byId("f_price"), f_image = byId("f_image"), f_file = byId("f_file"), f_preview = byId("f_preview");
            const formSave = byId("formSave"), formCancel = byId("formCancel");
            let editId = null; // null: th√™m m·ªõi; string: ƒëang s·ª≠a

            function openForm(p) {
                if (p) { // s·ª≠a
                    editId = p.id;
                    formTitle.textContent = "S·ª≠a s·∫£n ph·∫©m";
                    f_id.value = p.id; f_id.disabled = true;
                    f_name.value = p.name; f_cat.value = p.cat; f_price.value = p.price;
                    f_image.value = p.image || ""; f_preview.src = p.image || "";
                } else { // th√™m
                    editId = null;
                    formTitle.textContent = "Th√™m s·∫£n ph·∫©m";
                    f_id.disabled = false;
                    f_id.value = ""; f_name.value = ""; f_cat.value = ""; f_price.value = ""; f_image.value = ""; f_preview.removeAttribute("src");
                }
                formModal.style.display = "flex";
            }
            function closeForm() { formModal.style.display = "none"; f_file.value = ""; }

            // Ch·ªçn file ·∫£nh ‚Üí chuy·ªÉn base64 ƒë·ªÉ l∆∞u n·ªôi b·ªô
            f_file.addEventListener("change", () => {
                const file = f_file.files && f_file.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    const dataUrl = e.target.result;
                    f_image.value = dataUrl;
                    f_preview.src = dataUrl;
                };
                reader.readAsDataURL(file);
            });
            f_image.addEventListener("input", () => { f_preview.src = f_image.value; });

            function validateForm() {
                const id = f_id.value.trim().toUpperCase();
                const name = f_name.value.trim();
                const cat = f_cat.value.trim() || "Kh√°c";
                const price = Number(f_price.value);
                const image = f_image.value.trim();
                if (!id || !name || !price || price < 0) { alert("Vui l√≤ng nh·∫≠p ID, T√™n v√† Gi√° h·ª£p l·ªá."); return null; }
                if (!editId && products.some(p => p.id === id)) { alert("M√£ s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i."); return null; }
                return { id, name, cat, price, image };
            }

            formSave.onclick = () => {
                const data = validateForm(); if (!data) return;
                if (editId) { // c·∫≠p nh·∫≠t
                    const idx = products.findIndex(p => p.id === editId);
                    if (idx >= 0) products[idx] = { ...products[idx], ...data, id: editId }; // gi·ªØ nguy√™n id
                    // c·∫≠p nh·∫≠t gi·ªè n·∫øu c√≥
                    if (cart.has(editId)) {
                        const ci = cart.get(editId);
                        cart.set(editId, { ...ci, name: data.name, cat: data.cat, price: data.price });
                        renderCart();
                    }
                } else { // th√™m m·ªõi
                    products.push(data);
                }
                saveProducts();
                closeForm();
            };
            formCancel.onclick = closeForm;

            // ====== S·ª∞ KI·ªÜN ======
            byId("clearCart").onclick = clearCart;
            byId("hold").onclick = () => alert("Demo: 'Gi·ªØ ho√° ƒë∆°n' ch∆∞a tri·ªÉn khai.");
            payBtn.onclick = openPay; closePay.onclick = closePayModal; byId("completeSale").onclick = finalize;
            manageBtn.onclick = openManage; closeManage.onclick = closeManageModal; newProductBtn.onclick = () => openForm(null);
            discountInput.onchange = renderCart; taxRateSel.onchange = renderCart;

            // Ph√≠m t·∫Øt
            window.addEventListener("keydown", e => {
                if (e.key === "/") { e.preventDefault(); search.focus(); }
                if (e.altKey && (e.key === "p" || e.key === "P")) { e.preventDefault(); openPay(); }
                if (e.altKey && (e.key === "x" || e.key === "X")) { e.preventDefault(); clearCart(); }
                if (e.altKey && (e.key === "m" || e.key === "M")) { e.preventDefault(); openManage(); }
            });

            // ====== KH·ªûI T·∫†O ======
            function refreshAll() { renderCats(); renderProducts(); renderTable?.(); }
            refreshAll(); renderCart();

        })();
    </script>
</body>

</html>